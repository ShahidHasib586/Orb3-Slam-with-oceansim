# ORB-SLAM3 + ROS 2 Jazzy + OceanSim (Isaac Sim)

This repository demonstrates how to run **ORB-SLAM3 (monocular)** on image streams generated by **OceanSim** inside **Isaac Sim**, transported through **ROS 2 Jazzy**. It documents both the runtime pipeline and a full build guide for ORB-SLAM3 on Ubuntu 24.04.

---

## Demo overview
- **Bottom-right**: ORB-SLAM3 current frame view with tracked features.
- **Bottom-left**: ORB-SLAM3 map viewer showing the map and keyframes.
- **Top**: OceanSim viewport rendered by Isaac Sim.

---

## Tested setup
- **Operating system**: Ubuntu 24.04 LTS (Noble)
- **ROS 2 distribution**: Jazzy (apt packages)
- **GPU**: NVIDIA GeForce RTX 4060 Laptop GPU (8 GB)
- **NVIDIA drivers / CUDA**: Standard Ubuntu NVIDIA drivers (CUDA optional)
- **Isaac Sim**: [Isaac Sim Full 5.x](https://developer.nvidia.com/isaac-sim) (OceanSim USD + Python extensions)
- **Python**: 3.12
- **OpenCV**: 4.x from Ubuntu/ROS packages
- **Key ROS 2 packages**:
  - `ros-jazzy-image-transport`
  - `ros-jazzy-image-transport-plugins` (for the `compressed` transport)
  - `ros-jazzy-image-proc` (required for the 640×480 path)
  - `ros-jazzy-rqt-image-view` (optional preview tool)
  - `ros-jazzy-topic-tools` (optional utilities)
  - `ros-jazzy-v4l2-camera` (optional USB webcam testing)

> ORB-SLAM3 is built outside this repository and installed locally. The ROS 2 wrapper is used from `~/orb-slam3-root/ROS2_ORB_SLAM3`. Clone ORB-SLAM3 from the [official repository](https://github.com/UZ-SLAMLab/ORB_SLAM3) or the fork referenced in the build guide below. Obtain Isaac Sim from NVIDIA's official distribution.

---

## Folder layout

```
Orb3-Slam-with-oceansim/
├─ config/
│  ├─ my_cam_1080.yaml     # 1080p ORB-SLAM3 camera configuration (provided by you)
│  └─ TUM1.yaml            # Optional: 640×480 baseline camera file
├─ scripts/
│  └─ run_isaac_ros2_jazzy_fastdds.sh  # Launches OceanSim in Isaac Sim with the ROS 2 bridge
├─ ORB-SLAM3/              # Clone of ORB-SLAM3 (link to upstream repository)
├─ isaacsim/               # Local Isaac Sim installation (from NVIDIA)
├─ isaac_ros_ws/           # ROS 2 workspace for Isaac ROS packages (from NVIDIA)
├─ orb-slam3-root/         # Workspace for ORB-SLAM3 sources and ROS 2 wrapper
└─ README.md
```

Ensure that the `ORB-SLAM3`, `isaacsim`, and `isaac_ros_ws` directories point to the upstream projects or official distributions so that future updates can be pulled directly from their sources.

---

## 0. One-time prerequisites

```bash
sudo apt update
sudo apt install -y \
  ros-jazzy-image-transport \
  ros-jazzy-image-transport-plugins \
  ros-jazzy-image-proc \
  ros-jazzy-rqt-image-view \
  ros-jazzy-topic-tools
```

Make sure ORB-SLAM3 (and its ROS 2 wrapper) is built and installed locally. Example environment setup (adjust paths as needed):

```bash
# ORB-SLAM3 core + third-party libraries
export LD_LIBRARY_PATH=$HOME/ORB-SLAM3/lib:\
$HOME/ORB-SLAM3/Thirdparty/DBoW2/lib:\
$HOME/ORB-SLAM3/Thirdparty/g2o/lib:$LD_LIBRARY_PATH

# ROS 2 wrapper
source ~/orb-slam3-root/ROS2_ORB_SLAM3/install/setup.bash
```

---

## 1. Start OceanSim (Isaac Sim)

```bash
cd scripts
./run_isaac_ros2_jazzy_fastdds.sh
```

The script should publish a JPEG stream on `/oceansim/robot/uw_img` (`sensor_msgs/msg/CompressedImage`). Verify the topic:

```bash
source /opt/ros/jazzy/setup.bash
ros2 topic type /oceansim/robot/uw_img  # -> sensor_msgs/msg/CompressedImage
ros2 topic hz   /oceansim/robot/uw_img  # Expect ~20–30 Hz
```

---

## 2. Bridge JPEG → RAW (`bgr8`)

```bash
source /opt/ros/jazzy/setup.bash
ros2 run image_transport republish --ros-args \
  -p in_transport:=compressed -p out_transport:=raw \
  -r in/compressed:=/oceansim/robot/uw_img \
  -r out:=/camera/image_raw
```

Verify the output:

```bash
ros2 topic info /camera/image_raw -v
ros2 topic echo /camera/image_raw --once | egrep 'height|width|encoding'
# Expect encoding: bgr8, width/height matching your OceanSim camera
```

Optional preview:

```bash
ros2 run rqt_image_view rqt_image_view --ros-args -r image:=/camera/image_raw
```

---

## 3A. Run ORB-SLAM3 at 1080p (recommended)

Provide a camera file such as `config/my_cam_1080.yaml`. Example template for a 1920×1080 pinhole camera with zero distortion:

```yaml
# config/my_cam_1080.yaml
Camera.type: "Pinhole"
Camera.fps: 30
Camera.fx: 1551.918
Camera.fy: 1162.055
Camera.cx: 955.929
Camera.cy: 574.457
Camera.k1: 0.0
Camera.k2: 0.0
Camera.p1: 0.0
Camera.p2: 0.0
Camera.k3: 0.0
Camera.width: 1920
Camera.height: 1080
ORBextractor.nFeatures: 1000
ORBextractor.scaleFactor: 1.2
ORBextractor.nLevels: 8
ORBextractor.iniThFAST: 20
ORBextractor.minThFAST: 7
Viewer.KeyFrameSize: 0.05
Viewer.KeyFrameLineWidth: 1
Viewer.GraphLineWidth: 0.9
Viewer.PointSize: 2
Viewer.CameraSize: 0.08
Viewer.CameraLineWidth: 3
Viewer.ViewpointX: 0
Viewer.ViewpointY: -0.7
Viewer.ViewpointZ: -1.8
Viewer.ViewpointF: 500
```

Then run ORB-SLAM3 in a new terminal:

```bash
source ~/orb-slam3-root/ROS2_ORB_SLAM3/install/setup.bash
export LD_LIBRARY_PATH=$HOME/ORB-SLAM3/lib:$HOME/ORB-SLAM3/Thirdparty/DBoW2/lib:$HOME/ORB-SLAM3/Thirdparty/g2o/lib:$LD_LIBRARY_PATH

ros2 run orbslam3 mono \
  $HOME/ORB-SLAM3/Vocabulary/ORBvoc.txt \
  $(pwd)/config/my_cam_1080.yaml \
  --ros-args -r image:=/camera/image_raw -r /camera:=/camera/image_raw
```

You should see features in the Current Frame window and a growing map in the viewer.

---

## 3B. Alternative: Run at 640×480 with `TUM1.yaml`

Downscale the OceanSim feed:

**Terminal A — JPEG→RAW (1080p source)**

```bash
source /opt/ros/jazzy/setup.bash
ros2 run image_transport republish --ros-args \
  -p in_transport:=compressed -p out_transport:=raw \
  -r in/compressed:=/oceansim/robot/uw_img \
  -r out:=/camera/raw_1080
```

**Terminal B — Start a component container and load the resize node**

```bash
ros2 run rclcpp_components component_container_mt --ros-args -r __node:=img_proc_container
```

Load the component in another terminal:

```bash
ros2 component load /img_proc_container image_proc image_proc::ResizeNode \
  --node-name resize_640x480 \
  --param use_scale:=false --param width:=640 --param height:=480 \
  --remap image:=/camera/raw_1080 \
  --remap resize/image_raw:=/camera/image_raw \
  --remap resize/camera_info:=/camera/camera_info
```

Check the resized stream:

```bash
ros2 topic echo /camera/image_raw --once | egrep 'height|width|encoding'  # Expect 640 × 480, bgr8
```

**Terminal C — Run ORB-SLAM3 with `TUM1.yaml`**

```bash
source ~/orb-slam3-root/ROS2_ORB_SLAM3/install/setup.bash
export LD_LIBRARY_PATH=$HOME/ORB-SLAM3/lib:$HOME/ORB-SLAM3/Thirdparty/DBoW2/lib:$HOME/ORB-SLAM3/Thirdparty/g2o/lib:$LD_LIBRARY_PATH

ros2 run orbslam3 mono \
  $HOME/ORB-SLAM3/Vocabulary/ORBvoc.txt \
  $(pwd)/config/TUM1.yaml \
  --ros-args -r image:=/camera/image_raw -r /camera:=/camera/image_raw
```

---

## Troubleshooting

**Viewer says “WAITING FOR IMAGES”**
- Confirm the subscribed topic: `ros2 node info /ORB_SLAM3_ROS2` should list `/camera/image_raw`.
- Check that images arrive:
  ```bash
  ros2 topic echo /camera/image_raw --once | egrep 'height|width|encoding'
  ros2 topic hz /camera/image_raw
  ```
- Ensure the bridge is running and subscribed: `ros2 topic info /oceansim/robot/uw_img -v`.
- Reset stuck processes if needed:
  ```bash
  pkill -f -TERM 'image_transport.*republish|component_container|/orbslam3/mono|rqt_image_view|ros2 topic (hz|echo)'; sleep 1
  pkill -f -KILL 'image_transport.*republish|component_container|/orbslam3/mono|rqt_image_view|ros2 topic (hz|echo)'
  ros2 daemon stop; ros2 daemon start
  ```

**`libORB_SLAM3.so: cannot open shared object file`**
- Ensure `LD_LIBRARY_PATH` includes your ORB-SLAM3 libraries (see the environment block above).

**OpenCV/YAML errors (input file invalid or missing keys)**
- The YAML must include all required keys. Use the template above and keep `Camera.fps` as an integer. Include the `Viewer.*` fields.

**Deriving 1080p intrinsics**
- If you scale from a 640×480 file, use:
  
  ```text
  fx' = fx * (W'/W0)
  fy' = fy * (H'/H0)
  cx' = cx * (W'/W0)
  cy' = cy * (H'/H0)
  ```
- For best accuracy, calibrate your camera and use the measured intrinsics.

---

## Notes
- Do **not** commit `ORBvoc.txt` (it is large and already ignored).
- Underwater scenes can be low-texture; adjust `ORBextractor.nFeatures`, exposure, or add textured assets in OceanSim.
- For a quick sanity check, you can replace OceanSim with a laptop webcam topic (for example `/webcam/image_raw` using `v4l2_camera`).

---

## Credits
- ORB-SLAM3 © University of Zaragoza authors. Repository: https://github.com/UZ-SLAMLab/ORB_SLAM3
- Isaac Sim and OceanSim © NVIDIA. Product page: https://developer.nvidia.com/isaac-sim
- ROS 2 © Open Robotics and the ROS community.

---

# ORB-SLAM3 for ROS 2 on Ubuntu 24.04
**Tags:** ORB-SLAM3, ROS 2, SLAM, Ubuntu 24, Jazzy

## Purpose of this guide
Most online tutorials for ORB-SLAM3 target Ubuntu 22.04 or earlier releases. Ubuntu 24.04 (Noble Numbat) can also run ORB-SLAM3 with a few adjustments. This guide explains how to build ORB-SLAM3 and its ROS 2 wrapper using the default Ubuntu 24.04 toolchain.

You should be comfortable with basic Linux tasks such as editing files (vim/nano) and modifying `~/.bashrc`.

---

## Prerequisites

### Required
- Ubuntu 24.04 (either native or in a virtual machine)

### Optional
- Code editor (VS Code, vim, nano, …)
- ROS 2 Jazzy (recommended)
  - Make ROS 2 Jazzy available in every terminal by adding to `~/.bashrc`:
    ```bash
    source /opt/ros/jazzy/setup.bash
    ```

---

## Toolchain installation

### C/C++ compiler toolchain
```bash
sudo apt install build-essential
```
Ensure the following tools are present and at these versions (Ubuntu 24.04 defaults):

| Tool | Command | Expected version |
|------|---------|------------------|
| gcc  | `gcc --version` | 13.3.0 |
| g++  | `g++ --version` | 13.3.0 |
| cmake| `cmake --version` | 3.28.3 |

### Python virtualenvwrapper
Ubuntu 24.04 follows PEP 668, so global `pip` installs are discouraged. Use virtual environments:

```bash
sudo apt install python3-pip python3-virtualenv python3-virtualenvwrapper -y
```

Add to `~/.bashrc`:
```bash
source /usr/share/virtualenvwrapper/virtualenvwrapper.sh
```
Refresh the terminal:
```bash
source ~/.bashrc
```

Create and manage a virtual environment (defaults to Python 3.12):
```bash
mkvirtualenv orb-slam3
workon orb-slam3
# ...
deactivate
```

To force global installs despite PEP 668:
```bash
pip install <package-name> --break-system-packages
```

### Eigen3
- Dependency of ORB-SLAM3. Install version 3.4.0 (current as of 2025-02-15):
  ```bash
  sudo apt install libeigen3-dev
  ```

### OpenCV
- Dependency of ORB-SLAM3. Ubuntu 24.04 ships OpenCV 4.6.0, which matches `ros-jazzy-cv-bridge` (4.1.0). Avoid mixing other OpenCV versions.
  ```bash
  sudo apt install libopencv-dev
  ```

---

## Installation and compilation walkthrough

### Preparation
```bash
sudo apt update && sudo apt upgrade -y
workon orb-slam3
sudo apt install -y \
    build-essential \
    libeigen3-dev \
    libopencv-dev \
    libepoxy-dev   # Pangolin dependency

cd ~
mkdir orb-slam3-root && cd orb-slam3-root

# Define the ORB-SLAM3 root path
printf '\nexport ORB_SLAM3_ROOT_PATH=~/orb-slam3-root\n' >> ~/.bashrc
source ~/.bashrc
```

### Compile Pangolin
```bash
cd $ORB_SLAM3_ROOT_PATH
git clone https://github.com/stevenlovegrove/Pangolin
cd Pangolin
git checkout v0.9.2
mkdir build && cd build
cmake ..
make
```

Test Pangolin:
```bash
$ORB_SLAM3_ROOT_PATH/Pangolin/build/examples/HelloPangolin/HelloPangolin
```
You should see the Pangolin sample window.

### Compile ORB-SLAM3
```bash
cd $ORB_SLAM3_ROOT_PATH
git clone https://github.com/zang09/ORB-SLAM3-STEREO-FIXED.git ORB-SLAM3
```

Apply the following modifications:

- `$ORB_SLAM3_ROOT_PATH/ORB-SLAM3/CMakeLists.txt`
  - Line 33: `find_package(OpenCV 4.6)`
  - Remove the Eigen version pin:
    ```cmake
    find_package(Eigen3 REQUIRED)
    ```

- `$ORB_SLAM3_ROOT_PATH/ORB-SLAM3/build.sh`
  - If you are using fewer than four CPU cores (for example in a VM), adjust `make -j<n>` accordingly.

- `$ORB_SLAM3_ROOT_PATH/ORB-SLAM3/ThirdParty/DBoW2/CMakeLists.txt`
  - Line 32: `find_package(OpenCV 4.6 QUIET)`

- `$ORB_SLAM3_ROOT_PATH/ORB-SLAM3/ThirdParty/Sophus/CMakeLists.txt`
  - Line 23: add `-Wno-error=array-bounds` to the GCC flags:
    ```cmake
    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Werror -Wextra -std=c++11 -Wno-error=array-bounds -Wno-deprecated-declarations -ftemplate-backtrace-limit=0")
    ```
  - Line 35: remove the Eigen version requirement:
    ```cmake
    find_package(Eigen3 REQUIRED)
    ```

- `$ORB_SLAM3_ROOT_PATH/ORB-SLAM3/Examples/Monocular/mono_euroc.cc`
  - Change line 83 to pass `true` for the visualization flag:
    ```cpp
    ORB_SLAM3::System SLAM(argv[1], argv[2], ORB_SLAM3::System::MONOCULAR, true);
    ```

Make the script executable and build:

```bash
cd $ORB_SLAM3_ROOT_PATH/ORB-SLAM3
chmod +x build.sh
./build.sh
```

After the build, install Sophus system-wide so that the ROS 2 package can locate headers:
```bash
cd $ORB_SLAM3_ROOT_PATH/ORB-SLAM3/ThirdParty/Sophus/build
sudo make install
```

To remove Sophus later:
```bash
sudo rm -rf /usr/local/include/sophus
sudo rm -rf /usr/local/share/sophus
```

### Test ORB-SLAM3

Download and run the EuRoC dataset:
```bash
cd $ORB_SLAM3_ROOT_PATH/ORB-SLAM3
mkdir datasets && cd datasets
wget http://robotics.ethz.ch/~asl-datasets/ijrr_euroc_mav_dataset/machine_hall/MH_01_easy/MH_01_easy.zip
unzip MH_01_easy.zip
mkdir MH01
mv mav0 MH01/mav0
cd ..

./Examples/Monocular/mono_euroc ./Vocabulary/ORBvoc.txt ./Examples/Monocular/EuRoC.yaml ./datasets/MH01 ./Examples/Monocular/EuRoC_TimeStamps/MH01.txt dataset-MH01_mono
```
You should see the monocular viewer render the EuRoC sequence.

### Integrate with ROS 2

Install ROS 2 dependencies:
```bash
sudo apt install ros-${ROS_DISTRO}-cv-bridge ros-${ROS_DISTRO}-message-filters
```

Fetch the ROS 2 wrapper:
```bash
cd $ORB_SLAM3_ROOT_PATH
git clone https://github.com/zang09/ORB_SLAM3_ROS2 orbslam3_ros2
mkdir ROS2_ORB_SLAM3 && cd ROS2_ORB_SLAM3 && mkdir src && cd ..
mv orbslam3_ros2 ROS2_ORB_SLAM3/src/orbslam3_ros2
```

Update the build files:

- `$ORB_SLAM3_ROOT_PATH/ROS2_ORB_SLAM3/src/orbslam3_ros2/CMakeLists.txt`
  - Line 5: `set(ENV{PYTHONPATH} "/opt/ros/jazzy/lib/python3.12/site-packages/")`
  - Line 26: `find_package(OpenCV 4.6 REQUIRED)`
  - Add `OpenCV` to the `ament_target_dependencies` for `stereo` and `stereo-inertial` targets:
    ```cmake
    ament_target_dependencies(stereo rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin OpenCV)
    ament_target_dependencies(stereo-inertial rclcpp sensor_msgs cv_bridge ORB_SLAM3 Pangolin OpenCV)
    ```

- `$ORB_SLAM3_ROOT_PATH/ROS2_ORB_SLAM3/src/orbslam3_ros2/CMakeModules/FindORB_SLAM3.cmake`
  - Line 8: `set(ORB_SLAM3_ROOT_DIR "${ENV{ORB_SLAM3_ROOT_PATH}}/ORB-SLAM3")`

- Replace all occurrences of `#include <cv_bridge/cv_bridge.h>` with `#include <cv_bridge/cv_bridge.hpp>` inside `ROS2_ORB_SLAM3/src/orbslam3_ros2` (four locations).

Build the workspace:
```bash
workon orb-slam3
pip install catkin_pkg
cd $ORB_SLAM3_ROOT_PATH/ROS2_ORB_SLAM3
colcon build
```

Register the environment variables:
```bash
cat <<'BASHRC' >> ~/.bashrc
if [ -f "$ORB_SLAM3_ROOT_PATH/ROS2_ORB_SLAM3/install/setup.bash" ]; then
    source "$ORB_SLAM3_ROOT_PATH/ROS2_ORB_SLAM3/install/setup.bash"
fi
export LD_LIBRARY_PATH="$ORB_SLAM3_ROOT_PATH/ORB-SLAM3/lib:$LD_LIBRARY_PATH"
export LD_LIBRARY_PATH="$ORB_SLAM3_ROOT_PATH/Pangolin/build:$LD_LIBRARY_PATH"
BASHRC
```

Test the ROS 2 node:
```bash
ros2 run orbslam3 mono \
  $ORB_SLAM3_ROOT_PATH/ORB-SLAM3/Vocabulary/ORBvoc.txt \
  $ORB_SLAM3_ROOT_PATH/ORB-SLAM3/Examples/Monocular/TUM1.yaml
```

---

## Testing options

### Physical webcam test
- The default `orbslam3` ROS 2 package subscribes to `/camera`.
- The incoming image must be uncompressed (for example, YUYV422).
- Avoid low-texture or dark scenes. Adjust exposure if the image is black.

Publish webcam frames and preview:
```bash
sudo apt install ros-${ROS_DISTRO}-v4l2-camera ros-${ROS_DISTRO}-rqt-image-view
ros2 run v4l2_camera v4l2_camera_node --ros-args -r /image_raw:=/camera
ros2 run rqt_image_view rqt_image_view
```

Run ORB-SLAM3 monocular:
```bash
ros2 run orbslam3 mono \
  $ORB_SLAM3_ROOT_PATH/ORB-SLAM3/Vocabulary/ORBvoc.txt \
  $ORB_SLAM3_ROOT_PATH/ORB-SLAM3/Examples/Monocular/TUM1.yaml
```

### ROS 2 bag test
If webcam passthrough fails (for example in VirtualBox, where MJPEG is the only available format), use a ROS 2 bag:

```bash
cd $ORB_SLAM3_ROOT_PATH
# Option 1: Download manually from https://drive.google.com/drive/folders/1NY4KEW2qpfKlzR-674E-DFNkUEfDkJsC
# Option 2: Use gdown
workon orb-slam3
pip install gdown
gdown --folder https://drive.google.com/drive/folders/1NY4KEW2qpfKlzR-674E-DFNkUEfDkJsC

ros2 run orbslam3 mono \
  $ORB_SLAM3_ROOT_PATH/ORB-SLAM3/Vocabulary/ORBvoc.txt \
  $ORB_SLAM3_ROOT_PATH/ORB-SLAM3/Examples/Monocular/TUM1.yaml
ros2 bag play my_camera_bag
```

You should observe feature tracking and pose estimation while the bag is playing.

---

## Additional notes
- Ensure Jazzy environment variables are available in every terminal (`source /opt/ros/jazzy/setup.bash`).
- Keep your virtual environment (`workon orb-slam3`) active while building and running Python-based tools.
- Always reference the upstream ORB-SLAM3 and Isaac Sim repositories so that local copies stay aligned with official releases.

